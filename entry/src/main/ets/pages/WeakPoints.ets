import { WeakPointManager } from '../common/WeakPointManager'
import router from '@ohos.router'

interface WeakPointDisplayRecord {
  topic: string;
  subject: string;
  accuracy: string;
  color: string;
}

@Entry
@Component
struct WeakPoints {
  @State weakPointRecords: WeakPointDisplayRecord[] = [
    {
      topic: 'å…‰çš„æŠ˜å°„',
      subject: 'ç‰©ç†',
      accuracy: '60%',
      color: '#FF6B6B'
    } as WeakPointDisplayRecord,
    {
      topic: 'åˆ†æ•°è¿ç®—',
      subject: 'æ•°å­¦',
      accuracy: '75%',
      color: '#FFA726'
    } as WeakPointDisplayRecord,
    {
      topic: 'åŒ–å­¦æ–¹ç¨‹å¼',
      subject: 'åŒ–å­¦',
      accuracy: '45%',
      color: '#FF6B6B'
    } as WeakPointDisplayRecord,
    {
      topic: 'ä¸‰è§’å½¢æ€§è´¨',
      subject: 'æ•°å­¦',
      accuracy: '82%',
      color: '#4CAF50'
    } as WeakPointDisplayRecord,
    {
      topic: 'é‡åŠ›åŠ é€Ÿåº¦',
      subject: 'ç‰©ç†',
      accuracy: '70%',
      color: '#FFA726'
    } as WeakPointDisplayRecord
  ]
  @State selectedFilter: string = 'å…¨éƒ¨'
  @State totalWeakPoints: number = 0
  @State averageAccuracy: string = '0%'
  private weakPointManager: WeakPointManager = WeakPointManager.getInstance()

  aboutToAppear() {
    this.loadWeakPoints()
  }

  loadWeakPoints() {
    this.totalWeakPoints = this.weakPointManager.getWeakPointsCount()
    this.averageAccuracy = this.weakPointManager.getAverageAccuracy()
    // è¿™é‡Œå¯ä»¥ä»Ž WeakPointManager èŽ·å–çœŸå®žæ•°æ®
    // this.weakPointRecords = this.weakPointManager.getAllWeakPoints()
  }

  getFilteredRecords() {
    if (this.selectedFilter === 'å…¨éƒ¨') {
      return this.weakPointRecords
    }
    return this.weakPointRecords.filter(record => record.subject === this.selectedFilter)
  }

  onPractice(topic: string) {
    router.pushUrl({
      url: 'pages/Practice',
      params: {
        topic: topic,
        fromWeakPoints: true
      }
    })
  }

  @Builder
  FilterTabs() {
    Row() {
      ForEach(['å…¨éƒ¨', 'æ•°å­¦', 'ç‰©ç†', 'åŒ–å­¦'], (filter: string) => {
        Button(filter, { type: ButtonType.Capsule })
          .height(36)
          .fontSize(14)
          .backgroundColor(this.selectedFilter === filter ? '#667eea' : '#F5F5F5')
          .fontColor(this.selectedFilter === filter ? '#FFFFFF' : '#666666')
          .onClick(() => {
            this.selectedFilter = filter
          })
          .margin({ right: 12 })
      })
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  @Builder
  StatisticsCard() {
    Column() {
      Row() {
        Column() {
          Text(this.totalWeakPoints.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')
          Text('è–„å¼±çŸ¥è¯†ç‚¹')
            .fontSize(12)
            .fontColor('#888')
            .margin({ top: 4 })
        }
        .width('50%')

        Column() {
          Text(this.averageAccuracy)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#667eea')
          Text('å¹³å‡æ­£ç¡®çŽ‡')
            .fontSize(12)
            .fontColor('#888')
            .margin({ top: 4 })
        }
        .width('50%')
      }
      .width('100%')
      .padding(20)
    }
    .width('90%')
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#20000000',
      offsetX: 0,
      offsetY: 6
    })
    .margin({ bottom: 20 })
  }
  @Builder
  WeakPointItem(record: WeakPointDisplayRecord) {
    Row() {
      Stack() {
        Circle({ width: 50, height: 50 })
          .fill(record.subject === 'æ•°å­¦' ? '#E8F5E8' :
            record.subject === 'ç‰©ç†' ? '#E3F2FD' :
              record.subject === 'åŒ–å­¦' ? '#FFF3E0' : '#F3E5F5')

        Text(record.subject === 'æ•°å­¦' ? 'ðŸ“' :
          record.subject === 'ç‰©ç†' ? 'âš—ï¸' :
            record.subject === 'åŒ–å­¦' ? 'ðŸ§ª' : 'ðŸ“š')
          .fontSize(20)
      }
      .margin({ right: 16 })

      Column() {
        Row() {
          Text(record.topic)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#2C3E50')

          Blank()

          Text(record.subject)
            .fontSize(12)
            .fontColor('#667eea')
            .padding({
              left: 8,
              right: 8,
              top: 2,
              bottom: 2
            })
            .backgroundColor('#EEF2FF')
            .borderRadius(10)
        }
        .width('100%')
        .margin({ bottom: 8 })

        Row() {
          Text('æ­£ç¡®çŽ‡ï¼š')
            .fontSize(12)
            .fontColor('#888')
          Text(record.accuracy)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(record.color)
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Button('ç»ƒä¹ ')
        .width(60)
        .height(32)
        .fontSize(12)
        .backgroundColor('#667eea')
        .onClick(() => {
          this.onPractice(record.topic)
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#15000000',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 12 })
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('è¿”å›ž')
          .width(60)
          .height(32)
          .fontSize(12)
          .backgroundColor('#F5F5F5')
          .fontColor('#666')
          .onClick(() => {
            router.back()
          })

        Blank()

        Text('è–„å¼±è®°å½•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')

        Blank()

        Column()
          .width(60)
          .height(32)
      }
      .width('100%')
      .padding({
        left: 20,
        right: 20,
        top: 10,
        bottom: 10
      })
      .backgroundColor('#FFFFFF')

      Scroll() {
        Column() {
          // ç»Ÿè®¡å¡ç‰‡
          this.StatisticsCard()

          // ç­›é€‰æ ‡ç­¾
          this.FilterTabs()

          // è–„å¼±ç‚¹åˆ—è¡¨
          Column() {
            ForEach(this.getFilteredRecords(), (record: WeakPointDisplayRecord) => {
              this.WeakPointItem(record)
            })
          }
          .width('90%')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .padding({ bottom: 20 })
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#F8F8F8')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
  }
}