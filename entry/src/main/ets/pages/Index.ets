import { PhotoManager } from '../common/PhotoManager'
import { WeakPointManager } from '../common/WeakPointManager'
import { UserProfileManager } from '../common/UserProfileManager'
import router from '@ohos.router'

interface WeakPointItem {
  topic: string;
  subject: string;
  accuracy: string;
  color: string;
}

@Entry
@Component
struct Index {
  @State selectedTabIndex: number = 0
  @State weakPointsCount: number = 0
  @State practiceCount: number = 0
  @State studyStreak: number = 0
  private photoManager: PhotoManager = PhotoManager.getInstance()
  private weakPointManager: WeakPointManager = WeakPointManager.getInstance()
  private userProfileManager: UserProfileManager = UserProfileManager.getInstance()

  aboutToAppear() {
    this.loadStatistics()
  }

  loadStatistics() {
    this.weakPointsCount = this.weakPointManager.getWeakPointsCount()
    this.practiceCount = this.weakPointManager.getTotalPracticeCount()
    this.studyStreak = this.weakPointManager.getStudyStreak()
  }

  @Builder
  TabBuilder(title: string, targetIndex: number, normalIcon: Resource, selectedIcon: Resource) {
    Column() {
      Stack() {
        // èƒŒæ™¯å…‰æ™•æ•ˆæœï¼ˆé€‰ä¸­çŠ¶æ€ï¼‰
        if (this.selectedTabIndex === targetIndex) {
          Column() {
            Circle({ width: 48, height: 48 })
              .fill('#667eea')
              .opacity(0.15)
          }
          .width(52)
          .height(52)
          .position({ x: -4, y: -4 })
          .animation({
            duration: 300,
            curve: Curve.EaseInOut
          })

          // å¤–åœˆå…‰æ™•
          Circle({ width: 56, height: 56 })
            .fill('#667eea')
            .opacity(0.05)
            .position({ x: -8, y: -8 })
            .animation({
              duration: 400,
              curve: Curve.EaseInOut
            })
        }

        // å›¾æ ‡èƒŒæ™¯åœ†
        Circle({ width: 44, height: 44 })
          .fill(this.selectedTabIndex === targetIndex ? '#F0F4FF' : '#F8F8F8')
          .stroke(this.selectedTabIndex === targetIndex ? '#667eea' : '#E0E0E0')
          .strokeWidth(this.selectedTabIndex === targetIndex ? 2 : 1)
          .strokeDashArray(this.selectedTabIndex === targetIndex ? [] : [2, 4])
          .animation({
            duration: 250,
            curve: Curve.EaseInOut
          })

        // å›¾æ ‡
        Image(this.selectedTabIndex === targetIndex ? selectedIcon : normalIcon)
          .width(30)
          .height(30)
          .objectFit(ImageFit.Contain)
          .animation({
            duration: 250,
            curve: Curve.EaseInOut
          })
      }
      .width(44)
      .height(44)
      .margin({ bottom: 6 })

      // æ ‡é¢˜æ–‡å­—
      Text(title)
        .fontSize(this.selectedTabIndex === targetIndex ? 12 : 11)
        .fontWeight(this.selectedTabIndex === targetIndex ? FontWeight.Bold : FontWeight.Medium)
        .fontColor(this.selectedTabIndex === targetIndex ? '#667eea' : '#8E8E8E')
        .letterSpacing(this.selectedTabIndex === targetIndex ? 0.5 : 0)
        .animation({
          duration: 250,
          curve: Curve.EaseInOut
        })
    }
    .width('100%')
    .height(70)
    .justifyContent(FlexAlign.Center)
    .borderRadius(16)
    .margin({
      left: 3,
      right: 3,
      top: 6,
      bottom: 6
    })
    .scale({ x: this.selectedTabIndex === targetIndex ? 1.05 : 1, y: this.selectedTabIndex === targetIndex ? 1.05 : 1 })
    .onClick(() => {
      this.selectedTabIndex = targetIndex
    })
    .animation({
      duration: 250,
      curve: Curve.EaseInOut
    })
  }

  @Builder
  StudyCameraTab() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Image($r('app.media.home_phone'))
          .width(32)
        Text('æ‹ç…§å­¦ä¹ ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
        Blank()
      }
      .width('90%')
      .padding({ top: 20, bottom: 20 })
      .alignItems(VerticalAlign.Center)

      // å¿«é€Ÿæ“ä½œåŒºåŸŸ
      Column() {
        Text('å¿«é€Ÿå¼€å§‹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 20 })

        Row() {
          // æ‹ç…§å­¦ä¹ æŒ‰é’®
          Column() {
            Stack() {
              Circle({ width: 80, height: 80 })
                .fill('#1698CE')
              Text('ğŸ“¸')
                .fontSize(32)
                .fontColor('#FFFFFF')
            }

            Text('æ‹ç…§è¯†åˆ«')
              .fontSize(14)
              .fontColor('#2C3E50')
              .margin({ top: 12 })
          }
          .width('50%')
          .onClick(() => {
            router.pushUrl({ url: 'pages/CameraCapture' })
          })

          // å†å²è®°å½•æŒ‰é’®
          Column() {
            Stack() {
              Circle({ width: 80, height: 80 })
                .fill('#4CAF50')
              Text('ğŸ“š')
                .fontSize(32)
                .fontColor('#FFFFFF')
            }

            Text('å­¦ä¹ å†å²')
              .fontSize(14)
              .fontColor('#2C3E50')
              .margin({ top: 12 })
          }
          .width('50%')
          .onClick(() => {
            // åˆ‡æ¢åˆ°å­¦ä¹ å†å²Tab
            this.selectedTabIndex = 1
          })
        }
        .width('100%')
        .margin({ bottom: 30 })

        // ä»Šæ—¥å­¦ä¹ ç»Ÿè®¡
        Column() {
          Text('ä»Šæ—¥å­¦ä¹ ')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2C3E50')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 16 })

          Row() {
            Column() {
              Text('0')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#667eea')
              Text('æ‹ç…§æ¬¡æ•°')
                .fontSize(12)
                .fontColor('#888')
                .margin({ top: 4 })
            }
            .width('50%')

            Column() {
              Text('0')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#4CAF50')
              Text('è¯†åˆ«æˆåŠŸ')
                .fontSize(12)
                .fontColor('#888')
                .margin({ top: 4 })
            }
            .width('50%')
          }
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: '#15000000',
            offsetX: 0,
            offsetY: 4
          })
        }
        .width('100%')
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .shadow({
        radius: 12,
        color: '#20000000',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  WeakPointsTab() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('ğŸ“Š è–„å¼±è®°å½•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
      }
      .width('90%')
      .padding({ top: 20, bottom: 20 })

      // ç»Ÿè®¡å¡ç‰‡
      Row() {
        Column() {
          Text(this.weakPointsCount.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')
          Text('è–„å¼±çŸ¥è¯†ç‚¹')
            .fontSize(12)
            .fontColor('#888')
            .margin({ top: 4 })
        }
        .width('48%')
        .height(100)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: '#15000000',
          offsetX: 0,
          offsetY: 4
        })

        Blank()

        Column() {
          Text(this.practiceCount.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4CAF50')
          Text('ç»ƒä¹ æ¬¡æ•°')
            .fontSize(12)
            .fontColor('#888')
            .margin({ top: 4 })
        }
        .width('48%')
        .height(100)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: '#15000000',
          offsetX: 0,
          offsetY: 4
        })
      }
      .width('90%')
      .margin({ bottom: 20 })

      // è–„å¼±ç‚¹åˆ—è¡¨
      Column() {
        Text('è–„å¼±çŸ¥è¯†ç‚¹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 16 })

        // æ¨¡æ‹Ÿè–„å¼±ç‚¹æ•°æ®
        Column() {
          ForEach([
            {
              topic: 'å…‰çš„æŠ˜å°„',
              subject: 'ç‰©ç†',
              accuracy: '60%',
              color: '#FF6B6B'
            },
            {
              topic: 'åˆ†æ•°è¿ç®—',
              subject: 'æ•°å­¦',
              accuracy: '75%',
              color: '#FFA726'
            },
            {
              topic: 'åŒ–å­¦æ–¹ç¨‹å¼',
              subject: 'åŒ–å­¦',
              accuracy: '45%',
              color: '#FF6B6B'
            }
          ], (item: WeakPointItem) => {
            Row() {
              Column() {
                Text(item.topic)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#2C3E50')
                  .alignSelf(ItemAlign.Start)
                Text(item.subject)
                  .fontSize(12)
                  .fontColor('#888')
                  .margin({ top: 4 })
                  .alignSelf(ItemAlign.Start)
              }
              .layoutWeight(1)

              Column() {
                Text(item.accuracy)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(item.color)
                Text('æ­£ç¡®ç‡')
                  .fontSize(10)
                  .fontColor('#888')
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.End)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .margin({ bottom: 12 })
            .shadow({
              radius: 8,
              color: '#15000000',
              offsetX: 0,
              offsetY: 4
            })
          })
        }
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .shadow({
        radius: 12,
        color: '#20000000',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  MyProfileTab() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('æˆ‘çš„')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
        Blank()
        Button() {
          Image($r('app.media.person'))
            .width(20)
            .height(20)
            .fillColor('#FFFFFF')
        }
        .type(ButtonType.Circle)
        .width(48)
        .height(48)
        .backgroundColor('#667eea')
        .onClick(() => {
          router.pushUrl({ url: 'pages/MyProfile' })
        })
      }
      .width('90%')
      .padding({ top: 20, bottom: 20 })
      .alignItems(VerticalAlign.Center)

      // å¿«é€Ÿæ“ä½œåŒºåŸŸ
      Column() {
        Text('ä¸ªäººä¿¡æ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 20 })

        Row() {
          // åŸºæœ¬ä¿¡æ¯æŒ‰é’®
          Column() {
            Stack() {
              Circle({ width: 80, height: 80 })
                .fill('#1698CE')
              Text('ğŸ‘¤')
                .fontSize(32)
                .fontColor('#FFFFFF')
            }

            Text('åŸºæœ¬ä¿¡æ¯')
              .fontSize(14)
              .fontColor('#2C3E50')
              .margin({ top: 12 })
          }
          .width('50%')
          .onClick(() => {
            router.pushUrl({ url: 'pages/MyProfile' })
          })

          // å­¦ä¹ ç»Ÿè®¡æŒ‰é’®
          Column() {
            Stack() {
              Circle({ width: 80, height: 80 })
                .fill('#4CAF50')
              Text('ğŸ“Š')
                .fontSize(32)
                .fontColor('#FFFFFF')
            }

            Text('å­¦ä¹ ç»Ÿè®¡')
              .fontSize(14)
              .fontColor('#2C3E50')
              .margin({ top: 12 })
          }
          .width('50%')
          .onClick(() => {
            router.pushUrl({ url: 'pages/MyProfile' })
          })
        }
        .width('100%')
        .margin({ bottom: 30 })

        // ä»Šæ—¥å­¦ä¹ ç»Ÿè®¡
        Column() {
          Text('å­¦ä¹ æ¦‚è§ˆ')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2C3E50')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 16 })

          Row() {
            Column() {
              Text('15')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#667eea')
              Text('å­¦ä¹ å¤©æ•°')
                .fontSize(12)
                .fontColor('#888')
                .margin({ top: 4 })
            }
            .width('50%')

            Column() {
              Text('2')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#4CAF50')
              Text('è·å¾—æˆå°±')
                .fontSize(12)
                .fontColor('#888')
                .margin({ top: 4 })
            }
            .width('50%')
          }
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: '#15000000',
            offsetX: 0,
            offsetY: 4
          })
        }
        .width('100%')
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .shadow({
        radius: 12,
        color: '#20000000',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  PracticeTab() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('ğŸ¤ ç»ƒä¹ ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
      }
      .width('90%')
      .padding({ top: 20, bottom: 20 })

      // ç»ƒä¹ æ¨¡å¼é€‰æ‹©
      Column() {
        Text('é€‰æ‹©ç»ƒä¹ æ¨¡å¼')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 20 })

        // è–„å¼±ç‚¹ç»ƒä¹ 
        Row() {
          Stack() {
            Circle({ width: 60, height: 60 })
              .fill('#FF6B6B')
            Text('ğŸ¯')
              .fontSize(24)
              .fontColor('#FFFFFF')
          }
          .margin({ right: 16 })

          Column() {
            Text('è–„å¼±ç‚¹ç»ƒä¹ ')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#2C3E50')
              .alignSelf(ItemAlign.Start)
            Text('é’ˆå¯¹è–„å¼±çŸ¥è¯†ç‚¹ä¸“é¡¹ç»ƒä¹ ')
              .fontSize(13)
              .fontColor('#888')
              .margin({ top: 4 })
              .alignSelf(ItemAlign.Start)
          }
          .layoutWeight(1)

          Text('â†’')
            .fontSize(20)
            .fontColor('#CCC')
        }
        .width('100%')
        .height(80)
        .padding(16)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .margin({ bottom: 12 })
        .shadow({
          radius: 8,
          color: '#15000000',
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          router.pushUrl({ url: 'pages/Practice' })
        })

        // éšæœºç»ƒä¹ 
        Row() {
          Stack() {
            Circle({ width: 60, height: 60 })
              .fill('#4CAF50')
            Text('ğŸ²')
              .fontSize(24)
              .fontColor('#FFFFFF')
          }
          .margin({ right: 16 })

          Column() {
            Text('éšæœºç»ƒä¹ ')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#2C3E50')
              .alignSelf(ItemAlign.Start)
            Text('éšæœºæŠ½å–é¢˜ç›®ç»ƒä¹ ')
              .fontSize(13)
              .fontColor('#888')
              .margin({ top: 4 })
              .alignSelf(ItemAlign.Start)
          }
          .layoutWeight(1)

          Text('â†’')
            .fontSize(20)
            .fontColor('#CCC')
        }
        .width('100%')
        .height(80)
        .padding(16)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({
          radius: 8,
          color: '#15000000',
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          router.pushUrl({ url: 'pages/Practice' })
        })
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .shadow({
        radius: 12,
        color: '#20000000',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
    .alignItems(HorizontalAlign.Center)
  }

  build() {
    Column() {
      Tabs({ barPosition: BarPosition.End }) {
        TabContent() {
          this.StudyCameraTab()
        }
        .tabBar(this.TabBuilder('æ‹ç…§å­¦ä¹ ', 0, $r('app.media.home_phone'), $r('app.media.home_phone')))

        TabContent() {
          this.WeakPointsTab()
        }
        .tabBar(this.TabBuilder('é”™é¢˜è®°å½•', 1, $r('app.media.record'), $r('app.media.record')))

        TabContent() {
          this.PracticeTab()
        }
        .tabBar(this.TabBuilder('ç»ƒä¹ ', 2, $r('app.media.write'), $r('app.media.write')))

        TabContent() {
          this.MyProfileTab()
        }
        .tabBar(this.TabBuilder('æˆ‘çš„', 3, $r('app.media.person'), $r('app.media.person')))
      }
      .animationDuration(300)
      .backgroundColor('#F8F9FA')
      .barHeight(80)
      .barBackgroundColor('#FFFFFF')
      .barBackgroundBlurStyle(BlurStyle.NONE)
      .onChange((index: number) => {
        // Tabsç»„ä»¶çš„onChangeå›è°ƒä¸­ä¸èƒ½ç›´æ¥ä½¿ç”¨this
        // é€šè¿‡TabBuilderä¸­çš„onClickå·²ç»å¤„ç†äº†tabåˆ‡æ¢
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
  }
}