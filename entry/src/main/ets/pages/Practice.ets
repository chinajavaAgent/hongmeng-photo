import router from '@ohos.router'
// import { speechRecognizer } from '@kit.SpeechKit' // æš‚æ—¶æ³¨é‡Šæ‰ï¼ŒSDKå¯èƒ½ä¸æ”¯æŒ

interface Question {
  id: string;
  question: string;
  options?: string[];
  correctAnswer: string;
  explanation: string;
  type: 'multiple_choice' | 'calculation' | 'text_input';
}

@Entry
@Component
struct Practice {
  @State currentQuestionIndex: number = 0;
  @State userAnswer: string = '';
  @State isRecording: boolean = false;
  @State showResult: boolean = false;
  @State isCorrect: boolean = false;
  @State questions: Question[] = [];
  @State topic: string = 'åˆ†æ•°è¿ç®—';
  @State subject: string = 'æ•°å­¦';
  @State score: number = 0;
  @State totalQuestions: number = 0;
  @State showFinalScore: boolean = false;

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params?.topic) {
      this.topic = params.topic as string;
    }
    if (params?.subject) {
      this.subject = params.subject as string;
    }
    this.loadQuestions();
  }

  loadQuestions() {
    // æ ¹æ®ä¸»é¢˜ç”Ÿæˆç»ƒä¹ é¢˜
    if (this.topic === 'åˆ†æ•°è¿ç®—') {
      this.questions = [
        {
          id: '1',
          question: '2/3 + 1/6 = ?',
          correctAnswer: '5/6',
          explanation: 'é€šåˆ†åï¼š4/6 + 1/6 = 5/6',
          type: 'calculation'
        },
        {
          id: '2',
          question: 'ä¸‹é¢å“ªä¸ªåˆ†æ•°æœ€å¤§ï¼Ÿ',
          options: ['2/3', '3/4', '5/6', '1/2'],
          correctAnswer: '5/6',
          explanation: 'é€šåˆ†æ¯”è¾ƒï¼š8/12, 9/12, 10/12, 6/12ï¼Œæ‰€ä»¥5/6æœ€å¤§',
          type: 'multiple_choice'
        },
        {
          id: '3',
          question: '1 - 2/5 = ?',
          correctAnswer: '3/5',
          explanation: '1 = 5/5ï¼Œæ‰€ä»¥ 5/5 - 2/5 = 3/5',
          type: 'calculation'
        }
      ];
    } else if (this.topic === 'å…‰çš„æŠ˜å°„') {
      this.questions = [
        {
          id: '1',
          question: 'å…‰ä»ç©ºæ°”å°„å…¥æ°´ä¸­æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ',
          options: ['æŠ˜å°„è§’å¤§äºå…¥å°„è§’', 'æŠ˜å°„è§’å°äºå…¥å°„è§’', 'æŠ˜å°„è§’ç­‰äºå…¥å°„è§’', 'ä¸å‘ç”ŸæŠ˜å°„'],
          correctAnswer: 'æŠ˜å°„è§’å°äºå…¥å°„è§’',
          explanation: 'å…‰ä»å…‰ç–ä»‹è´¨å°„å…¥å…‰å¯†ä»‹è´¨æ—¶ï¼ŒæŠ˜å°„è§’å°äºå…¥å°„è§’',
          type: 'multiple_choice'
        },
        {
          id: '2',
          question: 'å½©è™¹æ˜¯æ€ä¹ˆå½¢æˆçš„ï¼Ÿ',
          correctAnswer: 'å…‰çš„è‰²æ•£',
          explanation: 'å¤ªé˜³å…‰ç»è¿‡æ°´æ»´æ—¶å‘ç”ŸæŠ˜å°„å’Œåå°„ï¼Œç™½å…‰è¢«åˆ†è§£æˆä¸ƒè‰²å…‰å½¢æˆå½©è™¹',
          type: 'text_input'
        }
      ];
    }
    
    this.totalQuestions = this.questions.length;
  }

  getCurrentQuestion(): Question {
    return this.questions[this.currentQuestionIndex] || this.questions[0];
  }

  async startVoiceInput() {
    this.isRecording = true;
    try {
      // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«
      await new Promise<void>(resolve => setTimeout(resolve, 2000));
      
      // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ
      const question = this.getCurrentQuestion();
      if (question.type === 'calculation') {
        this.userAnswer = question.correctAnswer; // æ¨¡æ‹Ÿæ­£ç¡®ç­”æ¡ˆ
      } else {
        this.userAnswer = 'æµ‹è¯•ç­”æ¡ˆ';
      }
    } catch (error) {
      console.error('Voice recognition error:', error);
      this.userAnswer = 'è¯†åˆ«å¤±è´¥';
    } finally {
      this.isRecording = false;
    }
  }

  stopVoiceInput() {
    this.isRecording = false;
  }

  submitAnswer() {
    const question = this.getCurrentQuestion();
    this.isCorrect = this.userAnswer.trim().toLowerCase() === question.correctAnswer.toLowerCase();
    
    if (this.isCorrect) {
      this.score++;
    }
    
    this.showResult = true;
  }

  nextQuestion() {
    if (this.currentQuestionIndex < this.questions.length - 1) {
      this.currentQuestionIndex++;
      this.userAnswer = '';
      this.showResult = false;
      this.isCorrect = false;
    } else {
      this.showFinalScore = true;
    }
  }

  restartPractice() {
    this.currentQuestionIndex = 0;
    this.score = 0;
    this.userAnswer = '';
    this.showResult = false;
    this.showFinalScore = false;
    this.isCorrect = false;
  }

  selectOption(option: string) {
    this.userAnswer = option;
  }

  getAccuracy(): number {
    return Math.round((this.score / this.totalQuestions) * 100);
  }

  @Builder QuestionDisplay() {
    Column() {
      // è·å–å½“å‰é¢˜ç›®
      // è¿›åº¦æŒ‡ç¤ºå™¨
      Row() {
        Text(`${this.currentQuestionIndex + 1}/${this.totalQuestions}`)
          .fontSize(14)
          .fontColor('#888')
        
        Blank()
        
        Progress({
          value: this.currentQuestionIndex + 1,
          total: this.totalQuestions,
          type: ProgressType.Linear
        })
          .width(200)
          .height(8)
          .color('#667eea')
          .backgroundColor('#E0E0E0')
      }
      .width('100%')
      .margin({ bottom: 30 })

      // é¢˜ç›®
      Text(this.getCurrentQuestion().question)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2C3E50')
        .textAlign(TextAlign.Center)
        .lineHeight(28)
        .margin({ bottom: 30 })

      // ç­”é¢˜åŒºåŸŸ
      if (this.getCurrentQuestion().type === 'multiple_choice' && this.getCurrentQuestion().options) {
        // é€‰æ‹©é¢˜
        Column() {
          ForEach(this.getCurrentQuestion().options!, (option: string, index: number) => {
            Button(option, { type: ButtonType.Capsule })
              .width('85%')
              .height(48)
              .fontSize(16)
              .backgroundColor(this.userAnswer === option ? '#667eea' : '#F5F5F5')
              .fontColor(this.userAnswer === option ? '#FFFFFF' : '#2C3E50')
              .onClick(() => {
                this.selectOption(option);
              })
              .margin({ bottom: 12 })
          })
        }
        .width('100%')
        .margin({ bottom: 20 })
      } else {
        // æ–‡æœ¬è¾“å…¥æˆ–è®¡ç®—é¢˜
        Column() {
          TextInput({ placeholder: 'è¯·è¾“å…¥ç­”æ¡ˆæˆ–ä½¿ç”¨è¯­éŸ³è¾“å…¥' })
            .width('85%')
            .height(48)
            .fontSize(16)
            .backgroundColor('#F5F5F5')
            .onChange((value: string) => {
              this.userAnswer = value;
            })

          // è¯­éŸ³è¾“å…¥æŒ‰é’®
          Row() {
            Button(this.isRecording ? 'å½•éŸ³ä¸­...' : 'ğŸ¤ è¯­éŸ³ç­”é¢˜', { type: ButtonType.Capsule })
              .width(140)
              .height(40)
              .fontSize(14)
              .backgroundColor(this.isRecording ? '#FF6B6B' : '#4CAF50')
              .onClick(() => {
                if (this.isRecording) {
                  this.stopVoiceInput();
                } else {
                  this.startVoiceInput();
                }
              })
            
            if (this.isRecording) {
              LoadingProgress()
                .width(24)
                .height(24)
                .color('#FFFFFF')
                .margin({ left: 12 })
            }
          }
          .margin({ top: 16 })
        }
        .width('100%')
        .margin({ bottom: 20 })
      }

      // æäº¤æŒ‰é’®
      if (this.userAnswer && !this.showResult) {
        Button('æäº¤ç­”æ¡ˆ', { type: ButtonType.Capsule })
          .width('60%')
          .height(48)
          .fontSize(16)
          .backgroundColor('#667eea')
          .onClick(() => {
            this.submitAnswer();
          })
      }
    }
    .width('100%')
    .padding(20)
  }

  @Builder ResultDisplay() {
    if (this.showResult) {
      Column() {
        // ç»“æœå›¾æ ‡
        Stack() {
          Circle({ width: 80, height: 80 })
            .fill(this.isCorrect ? '#4CAF50' : '#F44336')
          Text(this.isCorrect ? 'âœ“' : 'âœ—')
            .fontSize(40)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Bold)
        }
        .margin({ bottom: 24 })

        Text(this.isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'ç­”æ¡ˆé”™è¯¯')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isCorrect ? '#4CAF50' : '#F44336')
          .margin({ bottom: 16 })

        if (!this.isCorrect) {
          Text('æ­£ç¡®ç­”æ¡ˆï¼š' + this.getCurrentQuestion().correctAnswer)
            .fontSize(16)
            .fontColor('#2C3E50')
            .margin({ bottom: 12 })
        }

        Text(this.getCurrentQuestion().explanation)
          .fontSize(14)
          .fontColor('#666')
          .lineHeight(20)
          .textAlign(TextAlign.Center)
          .padding(16)
          .backgroundColor('#F8F9FA')
          .borderRadius(12)
          .margin({ bottom: 30 })

        Button(this.currentQuestionIndex < this.questions.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'æŸ¥çœ‹æˆç»©', 
               { type: ButtonType.Capsule })
          .width('60%')
          .height(48)
          .fontSize(16)
          .backgroundColor('#667eea')
          .onClick(() => {
            this.nextQuestion();
          })
      }
      .width('100%')
      .padding(20)
      .alignItems(HorizontalAlign.Center)
    }
  }

  @Builder FinalScoreDisplay() {
    if (this.showFinalScore) {
      Column() {
        Stack() {
          Circle({ width: 120, height: 120 })
            .fill('#667eea')
          Column() {
            Text(this.score.toString())
              .fontSize(36)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
            Text(`/${this.totalQuestions}`)
              .fontSize(18)
              .fontColor('#FFFFFF')
              .margin({ top: -8 })
          }
        }
        .margin({ bottom: 24 })

        Text('ç»ƒä¹ å®Œæˆï¼')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
          .margin({ bottom: 16 })

        Text(`æ­£ç¡®ç‡ï¼š${this.getAccuracy()}%`)
          .fontSize(18)
          .fontColor('#4CAF50')
          .margin({ bottom: 30 })

        Column() {
          if (this.getAccuracy() >= 80) {
            Text('ğŸ‰ è¡¨ç°ä¼˜ç§€ï¼')
              .fontSize(16)
              .fontColor('#4CAF50')
              .margin({ bottom: 8 })
            Text('æ‚¨å¯¹è¯¥çŸ¥è¯†ç‚¹æŒæ¡å¾ˆå¥½ï¼Œç»§ç»­ä¿æŒï¼')
              .fontSize(14)
              .fontColor('#666')
          } else if (this.getAccuracy() >= 60) {
            Text('ğŸ“š è¿˜éœ€åŠªåŠ›')
              .fontSize(16)
              .fontColor('#FF9800')
              .margin({ bottom: 8 })
            Text('å»ºè®®å¤šç»ƒä¹ ç›¸å…³é¢˜ç›®ï¼ŒåŠ å¼ºç†è§£')
              .fontSize(14)
              .fontColor('#666')
          } else {
            Text('ğŸ’ª éœ€è¦åŠ å¼º')
              .fontSize(16)
              .fontColor('#F44336')
              .margin({ bottom: 8 })
            Text('è¯¥çŸ¥è¯†ç‚¹éœ€è¦é‡ç‚¹å¤ä¹ ï¼Œå»ºè®®å¯»æ±‚å¸®åŠ©')
              .fontSize(14)
              .fontColor('#666')
          }
        }
        .width('85%')
        .padding(16)
        .backgroundColor('#F8F9FA')
        .borderRadius(12)
        .margin({ bottom: 30 })

        Row() {
          Button('å†ç»ƒä¸€æ¬¡', { type: ButtonType.Capsule })
            .width('45%')
            .height(44)
            .fontSize(14)
            .backgroundColor('#667eea')
            .onClick(() => {
              this.restartPractice();
            })
          
          Blank()
          
          Button('è¿”å›é¦–é¡µ', { type: ButtonType.Capsule })
            .width('45%')
            .height(44)
            .fontSize(14)
            .backgroundColor('#4CAF50')
            .onClick(() => {
              router.back();
            })
        }
        .width('85%')
      }
      .width('100%')
      .padding(20)
      .alignItems(HorizontalAlign.Center)
    }
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('è¿”å›', { type: ButtonType.Capsule })
          .width(60)
          .height(32)
          .fontSize(12)
          .backgroundColor('#F5F5F5')
          .fontColor('#666')
          .onClick(() => {
            router.back();
          })
        
        Blank()
        
        Column() {
          Text(this.topic)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2C3E50')
          Text(this.subject + ' ç»ƒä¹ ')
            .fontSize(12)
            .fontColor('#888')
            .margin({ top: 2 })
        }
        
        Blank()
        
        Column() {
          Text('å¾—åˆ†')
            .fontSize(10)
            .fontColor('#888')
          Text(this.score.toString())
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#667eea')
        }
        .width(60)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      .backgroundColor('#FFFFFF')

      Scroll() {
        Column() {
          if (this.showFinalScore) {
            this.FinalScoreDisplay()
          } else if (this.showResult) {
            this.ResultDisplay()
          } else {
            this.QuestionDisplay()
          }
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#F8F8F8')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
  }
}