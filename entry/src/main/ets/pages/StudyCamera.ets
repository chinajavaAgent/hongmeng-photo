import { PhotoManager } from '../common/PhotoManager'
import { RecognitionService, MockRecognitionService } from '../common/RecognitionService'
import router from '@ohos.router'

@Entry
@Component
struct StudyCamera {
  @State currentPhoto: string = ''
  @State isPhotoCaptured: boolean = false
  @State isTakingPhoto: boolean = false
  @State isAnalyzing: boolean = false
  @State recognizedText: string = ''
  @State showResult: boolean = false
  private photoManager: PhotoManager = PhotoManager.getInstance()
  private recognitionService: RecognitionService = new MockRecognitionService()

  aboutToAppear() {
    this.requestCameraPermission()
  }

  async requestCameraPermission() {
    await this.photoManager.requestPermissions()
  }

  async onTakePhoto() {
    try {
      this.isTakingPhoto = true
      const photoPath = await this.photoManager.takePhoto()
      if (photoPath) {
        this.currentPhoto = photoPath
        this.isPhotoCaptured = true
        // è‡ªåŠ¨å¼€å§‹è¯†åˆ«
        this.onRecognize()
      }
    } catch (error) {
      console.error('Photo capture error:', error)
    } finally {
      this.isTakingPhoto = false
    }
  }

  async onRecognize() {
    this.isAnalyzing = true
    try {
      // æ¨¡æ‹Ÿè¯†åˆ«è¿‡ç¨‹
      await new Promise<void>(resolve => setTimeout(resolve, 2000))

      // æ¨¡æ‹Ÿè¯†åˆ«ç»“æžœ
      const studyTopics = ['å…‰çš„æŠ˜å°„', 'åˆ†æ•°è¿ç®—', 'åŒ–å­¦æ–¹ç¨‹å¼', 'ä¸‰è§’å½¢æ€§è´¨', 'é‡åŠ›åŠ é€Ÿåº¦']
      this.recognizedText = studyTopics[Math.floor(Math.random() * studyTopics.length)]

      this.showResult = true
    } catch (error) {
      console.error('Recognition error:', error)
    } finally {
      this.isAnalyzing = false
    }
  }

  onRetake() {
    this.currentPhoto = ''
    this.isPhotoCaptured = false
    this.showResult = false
    this.recognizedText = ''
  }

  onStartPractice() {
    if (this.recognizedText) {
      router.pushUrl({
        url: 'pages/Practice',
        params: {
          topic: this.recognizedText,
          fromCamera: true
        }
      })
    }
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('è¿”å›ž')
          .width(60)
          .height(32)
          .fontSize(12)
          .backgroundColor('#F5F5F5')
          .fontColor('#666')
          .onClick(() => {
            router.back()
          })

        Blank()

        Text('æ‹ç…§å­¦ä¹ ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')

        Blank()

        Column()
          .width(60)
          .height(32)
      }
      .width('100%')
      .padding({
        left: 20,
        right: 20,
        top: 10,
        bottom: 10
      })
      .backgroundColor('#FFFFFF')

      Scroll() {
        Column() {
          // æ‹ç…§é¢„è§ˆåŒºåŸŸ
          Stack() {
            if (this.isPhotoCaptured && this.currentPhoto) {
              Image(this.currentPhoto)
                .width('85%')
                .aspectRatio(4 / 3)
                .objectFit(ImageFit.Cover)
                .borderRadius(16)
                .shadow({
                  radius: 16,
                  color: '#20000000',
                  offsetX: 0,
                  offsetY: 8
                })
            } else {
              Column() {
                Text('ðŸ“·')
                  .fontSize(60)
                  .fontColor('#C0C0C0')
                  .opacity(0.6)
                Text('æ‹æ‘„å­¦ä¹ å†…å®¹')
                  .fontSize(16)
                  .fontColor('#888')
                  .margin({ top: 20 })
                Text('è‡ªåŠ¨è¯†åˆ«çŸ¥è¯†ç‚¹')
                  .fontSize(12)
                  .fontColor('#BBB')
                  .margin({ top: 8 })
              }
              .width('85%')
              .aspectRatio(4 / 3)
              .justifyContent(FlexAlign.Center)
              .backgroundColor('#F8F8F8')
              .borderRadius(16)
              .border({
                width: 2,
                color: '#E0E0E0',
                style: BorderStyle.Dashed
              })
            }
          }
          .width('100%')
          .margin({ top: 30 })

          // è¯†åˆ«ç»“æžœæ˜¾ç¤º
          if (this.showResult && this.recognizedText) {
            Column() {
              Text('ðŸŽ¯ è¯†åˆ«ç»“æžœ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C3E50')
                .margin({ bottom: 12 })

              Text('è¯†åˆ«åˆ°ï¼š' + this.recognizedText)
                .fontSize(16)
                .fontColor('#4CAF50')
                .textAlign(TextAlign.Center)
                .backgroundColor('#F1F8E9')
                .padding(16)
                .borderRadius(8)
                .width('85%')
                .margin({ bottom: 20 })

              // å¼€å§‹ç»ƒä¹ æŒ‰é’®
              Button('å¼€å§‹ç»ƒä¹ ', { type: ButtonType.Capsule })
                .width('75%')
                .height(48)
                .fontSize(16)
                .backgroundColor('#4CAF50')
                .onClick(() => {
                  this.onStartPractice()
                })
            }
            .width('100%')
            .margin({ top: 20 })
            .alignItems(HorizontalAlign.Center)
          }

          // åˆ†æžä¸­çŠ¶æ€
          if (this.isAnalyzing) {
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color('#667eea')
              Text('æ­£åœ¨è¯†åˆ«å†…å®¹...')
                .fontSize(14)
                .fontColor('#667eea')
                .margin({ top: 12 })
            }
            .margin({ top: 30 })
          }

          // æ‹ç…§æŽ§åˆ¶æŒ‰é’®
          if (!this.isPhotoCaptured) {
            Button(this.isTakingPhoto ? 'å¯åŠ¨ä¸­...' : 'ðŸ“¸ æ‹æ‘„', { type: ButtonType.Capsule })
              .width('75%')
              .height(56)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .backgroundColor('#1698CE')
              .enabled(!this.isTakingPhoto)
              .onClick(() => {
                this.onTakePhoto()
              })
              .shadow({
                radius: 15,
                color: '#30667eea',
                offsetX: 0,
                offsetY: 6
              })
              .margin({ top: 40 })
          }

          // é‡æ‹æŒ‰é’®
          if (this.isPhotoCaptured && !this.isAnalyzing) {
            Button('ðŸ”„ é‡æ–°æ‹æ‘„', { type: ButtonType.Capsule })
              .width('60%')
              .height(44)
              .fontSize(14)
              .backgroundColor('#FF6B6B')
              .onClick(() => {
                this.onRetake()
              })
              .margin({ top: 20 })
          }
        }
        .width('100%')
        .padding({ bottom: 40 })
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
  }
}