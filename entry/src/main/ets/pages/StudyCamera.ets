import { camera } from '@kit.CameraKit'
import { image } from '@kit.ImageKit'
import { PhotoManager } from '../common/PhotoManager'
import router from '@ohos.router'

interface RecommendationCard {
  id: string;
  title: string;
  description: string;
  subject: string;
  difficulty: string;
  relatedTopic: string;
  icon: string;
}

@Entry
@Component
struct StudyCamera {
  @State currentPhoto: string = '';
  @State isPhotoCaptured: boolean = false;
  @State isTakingPhoto: boolean = false;
  @State isAnalyzing: boolean = false;
  @State showRecommendation: boolean = false;
  @State recommendationCard: RecommendationCard | null = null;
  @State recognizedObject: string = '';
  private photoManager: PhotoManager = PhotoManager.getInstance();

  // æ¨¡æ‹Ÿæ¨èæ•°æ®
  private recommendations: RecommendationCard[] = [
    {
      id: '1',
      title: 'å…‰çš„æŠ˜å°„',
      description: 'å­¦ä¹ å…‰çº¿åœ¨ä¸åŒä»‹è´¨ä¸­çš„ä¼ æ’­è§„å¾‹ï¼Œç†è§£å½©è™¹å½¢æˆåŸç†',
      subject: 'ç‰©ç†',
      difficulty: 'ä¸­ç­‰',
      relatedTopic: 'å…‰å­¦',
      icon: 'ğŸŒˆ'
    },
    {
      id: '2',
      title: 'åˆ†æ•°çš„åŠ å‡è¿ç®—',
      description: 'æŒæ¡åˆ†æ•°é€šåˆ†ä¸åŒ–ç®€ï¼Œæå‡è®¡ç®—å‡†ç¡®æ€§',
      subject: 'æ•°å­¦',
      difficulty: 'åŸºç¡€',
      relatedTopic: 'åˆ†æ•°è¿ç®—',
      icon: 'â•'
    },
    {
      id: '3',
      title: 'åŒ–å­¦ååº”',
      description: 'äº†è§£é…¸ç¢±ä¸­å’Œååº”ï¼Œè§‚å¯Ÿå®éªŒç°è±¡',
      subject: 'åŒ–å­¦',
      difficulty: 'ä¸­ç­‰',
      relatedTopic: 'åŒ–å­¦å®éªŒ',
      icon: 'âš—ï¸'
    }
  ];

  aboutToAppear() {
    this.requestCameraPermission();
  }

  async requestCameraPermission() {
    await this.photoManager.requestPermissions();
  }

  async onTakePhoto() {
    try {
      this.isTakingPhoto = true;
      const photoPath = await this.photoManager.takePhoto();
      if (photoPath) {
        this.currentPhoto = photoPath;
        this.isPhotoCaptured = true;
        // è‡ªåŠ¨å¼€å§‹è¯†åˆ«
        this.onRecognize();
      }
    } catch (error) {
      console.error('Photo capture error:', error);
    } finally {
      this.isTakingPhoto = false;
    }
  }

  async onRecognize() {
    this.isAnalyzing = true;
    try {
      // æ¨¡æ‹Ÿè¯†åˆ«è¿‡ç¨‹
      await new Promise<void>(resolve => setTimeout(resolve, 2000));
      
      // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ
      const recognizedObjects = ['å½©è™¹', 'ä¸‰è§’å½¢', 'åŒ–å­¦å®éªŒå™¨æ'];
      this.recognizedObject = recognizedObjects[Math.floor(Math.random() * recognizedObjects.length)];
      
      // æ ¹æ®è¯†åˆ«ç»“æœåŒ¹é…æ¨è
      this.matchRecommendation();
    } catch (error) {
      console.error('Recognition error:', error);
    } finally {
      this.isAnalyzing = false;
    }
  }

  matchRecommendation() {
    // æ ¹æ®è¯†åˆ«çš„ç‰©ä½“åŒ¹é…ç›¸åº”çš„å­¦ä¹ å†…å®¹
    let matchedCard: RecommendationCard | null = null;
    
    if (this.recognizedObject === 'å½©è™¹') {
      matchedCard = this.recommendations[0]; // å…‰çš„æŠ˜å°„
    } else if (this.recognizedObject === 'ä¸‰è§’å½¢') {
      matchedCard = this.recommendations[1]; // åˆ†æ•°è¿ç®—ï¼ˆç¤ºä¾‹ï¼‰
    } else if (this.recognizedObject === 'åŒ–å­¦å®éªŒå™¨æ') {
      matchedCard = this.recommendations[2]; // åŒ–å­¦ååº”
    }
    
    if (matchedCard) {
      this.recommendationCard = matchedCard;
      this.showRecommendation = true;
    }
  }

  onRetake() {
    this.currentPhoto = '';
    this.isPhotoCaptured = false;
    this.showRecommendation = false;
    this.recommendationCard = null;
    this.recognizedObject = '';
  }

  onStartPractice() {
    if (this.recommendationCard) {
      router.pushUrl({
        url: 'pages/Practice',
        params: { 
          topic: this.recommendationCard.relatedTopic,
          subject: this.recommendationCard.subject,
          fromRecommendation: true
        }
      });
    }
  }

  onDismissRecommendation() {
    this.showRecommendation = false;
    this.recommendationCard = null;
  }

  @Builder RecommendationAlert() {
    if (this.showRecommendation && this.recommendationCard) {
      Stack() {
        Column() {}
          .width('100%')
          .height('100%')
          .backgroundColor('#80000000')
          .onClick(() => {
            this.onDismissRecommendation();
          })

        Column() {
          // è­¦å‘Šå›¾æ ‡
          Stack() {
            Circle({ width: 60, height: 60 })
              .fill('#FF6B6B')
            Text('âš ï¸')
              .fontSize(30)
          }
          .margin({ bottom: 20 })

          Text('å‘ç°è–„å¼±ç‚¹åŒ¹é…!')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2C3E50')
            .margin({ bottom: 16 })

          // æ¨èå¡ç‰‡
          Column() {
            Row() {
              Text(this.recommendationCard.icon)
                .fontSize(24)
                .margin({ right: 12 })
              
              Column() {
                Text(this.recommendationCard.title)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2C3E50')
                  .alignSelf(ItemAlign.Start)
                
                Text(this.recommendationCard.subject + ' Â· ' + this.recommendationCard.difficulty)
                  .fontSize(12)
                  .fontColor('#667eea')
                  .margin({ top: 4 })
                  .alignSelf(ItemAlign.Start)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
            .margin({ bottom: 12 })

            Text(this.recommendationCard.description)
              .fontSize(14)
              .fontColor('#666')
              .lineHeight(20)
              .textAlign(TextAlign.Start)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#F8F9FA')
          .borderRadius(12)
          .margin({ bottom: 24 })

          Row() {
            Button('ç¨åå†è¯´', { type: ButtonType.Capsule })
              .width('45%')
              .height(44)
              .fontSize(14)
              .backgroundColor('#E0E0E0')
              .fontColor('#666')
              .onClick(() => {
                this.onDismissRecommendation();
              })
            
            Blank()
            
            Button('ç«‹å³ç»ƒä¹ ', { type: ButtonType.Capsule })
              .width('45%')
              .height(44)
              .fontSize(14)
              .backgroundColor('#4CAF50')
              .onClick(() => {
                this.onStartPractice();
              })
          }
          .width('100%')
        }
        .width('85%')
        .padding(24)
        .backgroundColor('#FFFFFF')
        .borderRadius(20)
        .shadow({
          radius: 24,
          color: '#40000000',
          offsetX: 0,
          offsetY: 12
        })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(999)
    }
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('è¿”å›', { type: ButtonType.Capsule })
          .width(60)
          .height(32)
          .fontSize(12)
          .backgroundColor('#F5F5F5')
          .fontColor('#666')
          .onClick(() => {
            router.back();
          })
        
        Blank()
        
        Text('æ‹ç…§å­¦ä¹ ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2C3E50')
        
        Blank()
        
        Column() {}
          .width(60)
          .height(32)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      .backgroundColor('#FFFFFF')

      Scroll() {
        Column() {
          // æ‹ç…§é¢„è§ˆåŒºåŸŸ
          Stack() {
            if (this.isPhotoCaptured && this.currentPhoto) {
              Image(this.currentPhoto)
                .width('85%')
                .aspectRatio(4/3)
                .objectFit(ImageFit.Cover)
                .borderRadius(16)
                .shadow({
                  radius: 16,
                  color: '#20000000',
                  offsetX: 0,
                  offsetY: 8
                })
            } else {
              Column() {
                Image($r('sys.media.ohos_ic_public_camera'))
                  .width(80)
                  .height(80)
                  .fillColor('#C0C0C0')
                  .opacity(0.6)
                Text('æ‹æ‘„å­¦ä¹ å†…å®¹')
                  .fontSize(16)
                  .fontColor('#888')
                  .margin({ top: 20 })
                Text('æ™ºèƒ½è¯†åˆ«å¹¶æ¨èç›¸å…³ç»ƒä¹ ')
                  .fontSize(12)
                  .fontColor('#BBB')
                  .margin({ top: 8 })
              }
              .width('85%')
              .aspectRatio(4/3)
              .justifyContent(FlexAlign.Center)
              .backgroundColor('#F8F8F8')
              .borderRadius(16)
              .border({
                width: 2,
                color: '#E0E0E0',
                style: BorderStyle.Dashed
              })
            }
          }
          .width('100%')
          .margin({ top: 30 })

          // è¯†åˆ«ç»“æœæ˜¾ç¤º
          if (this.recognizedObject) {
            Column() {
              Text('ğŸ¯ è¯†åˆ«ç»“æœ')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C3E50')
                .margin({ bottom: 12 })

              Text('è¯†åˆ«åˆ°ï¼š' + this.recognizedObject)
                .fontSize(14)
                .fontColor('#4CAF50')
                .textAlign(TextAlign.Center)
                .backgroundColor('#F1F8E9')
                .padding(12)
                .borderRadius(8)
                .width('85%')
            }
            .width('100%')
            .margin({ top: 20 })
            .alignItems(HorizontalAlign.Center)
          }

          // åˆ†æä¸­çŠ¶æ€
          if (this.isAnalyzing) {
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color('#667eea')
              Text('æ­£åœ¨æ™ºèƒ½è¯†åˆ«å†…å®¹...')
                .fontSize(14)
                .fontColor('#667eea')
                .margin({ top: 12 })
            }
            .margin({ top: 30 })
          }

          // æ‹ç…§æ§åˆ¶æŒ‰é’®
          if (!this.isPhotoCaptured) {
            Button(this.isTakingPhoto ? 'å¯åŠ¨ä¸­...' : 'ğŸ“¸ æ‹æ‘„å­¦ä¹ ', { type: ButtonType.Capsule })
              .width('75%')
              .height(56)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .backgroundColor('#1698CE')
              .enabled(!this.isTakingPhoto)
              .onClick(() => {
                this.onTakePhoto();
              })
              .shadow({
                radius: 15,
                color: '#30667eea',
                offsetX: 0,
                offsetY: 6
              })
              .margin({ top: 40 })
          }

          // é‡æ‹æŒ‰é’®
          if (this.isPhotoCaptured && !this.isAnalyzing) {
            Button('ğŸ”„ é‡æ–°æ‹æ‘„', { type: ButtonType.Capsule })
              .width('60%')
              .height(44)
              .fontSize(14)
              .backgroundColor('#FF6B6B')
              .onClick(() => {
                this.onRetake();
              })
              .margin({ top: 20 })
          }

          // å­¦ä¹ å»ºè®®åŒºåŸŸ
          if (!this.showRecommendation && this.recognizedObject && !this.isAnalyzing) {
            Column() {
              Text('ğŸ’¡ å­¦ä¹ å»ºè®®')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#2C3E50')
                .margin({ bottom: 16 })

              Text('åŸºäºæ‚¨æ‹æ‘„çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¼šä¸ºæ‚¨æ¨èç›¸å…³çš„å­¦ä¹ èµ„æ–™å’Œç»ƒä¹ é¢˜ç›®ã€‚ç»§ç»­å­¦ä¹ ä»¥æé«˜æ‚¨çš„çŸ¥è¯†æ°´å¹³ï¼')
                .fontSize(14)
                .fontColor('#666')
                .lineHeight(22)
                .textAlign(TextAlign.Center)
                .padding(16)
                .backgroundColor('#FFFFFF')
                .borderRadius(12)
                .shadow({
                  radius: 8,
                  color: '#15000000',
                  offsetX: 0,
                  offsetY: 4
                })
            }
            .width('85%')
            .margin({ top: 30 })
            .alignItems(HorizontalAlign.Center)
          }
        }
        .width('100%')
        .padding({ bottom: 40 })
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .layoutWeight(1)

      // æ¨èå¼¹çª—
      this.RecommendationAlert()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
  }
}